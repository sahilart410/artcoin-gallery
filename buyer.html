<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ArtCoin â€” Buyer Portal (on-chain)</title>
<style>:root{--brand:#6D53F1}body{font-family:Inter,system-ui,Arial,sans-serif;background:#0e102d;color:#fff;margin:0}
.wrap{max-width:960px;margin:0 auto;padding:24px}.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin-top:16px}
label{display:block;margin:8px 0 6px;color:#cfd3ff;font-size:13px}input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff}
.btn{background:var(--brand);border:none;color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}</style>
</head><body>
<div class="wrap">
  <h1>Buyer Portal</h1>
  <div class="card">
    <div class="row"><button class="btn" id="btnConnect">Connect Phantom</button><span id="who"></span></div>
    <label>Seller public key</label><input id="seller" placeholder="Seller pubkey (Base58)">
    <label>Amount (USDT, 6 decimals)</label><input id="amount" type="number" step="0.01" placeholder="e.g. 120.00">
    <label>Expires at (unix ts)</label><input id="exp" type="number" placeholder="e.g. 1735689600">
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnInit">1) Init Escrow</button>
      <button class="btn" id="btnFund">2) Fund</button>
      <button class="btn" id="btnConfirm">3) Confirm Delivery</button>
      <button class="btn" id="btnRefund">Refund (if expired)</button>
    </div>
    <pre id="out"></pre>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script>
const out = (m)=>{ document.getElementById('out').textContent = (m && typeof m==='object')? JSON.stringify(m,null,2): String(m); };
let buyerPk='';
async function connect(){ const p = window.solana; if(!p || !p.isPhantom){ alert('Install Phantom'); return; } const r = await p.connect(); buyerPk = r.publicKey.toString(); document.getElementById('who').textContent = buyerPk; }
function toUnits(x){ return Math.round(Number(x) * 1_000_000); }
async function signSend(b64){ const tx = window.solanaWeb3.Transaction.from(Buffer.from(b64, 'base64')); const { signature } = await window.solana.signAndSendTransaction(tx); return signature; }
async function initEscrow(){ const seller = document.getElementById('seller').value.trim(); const amountUnits = toUnits(document.getElementById('amount').value); const expiresAt = Number(document.getElementById('exp').value);
  const r = await fetch('/api/onchain/initTx',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyerPubkey:buyerPk,sellerPubkey:seller,amountUnits,expiresAt})}).then(r=>r.json());
  if(!r.ok) return out(r); const sig = await signSend(r.tx); out({ step:'initEscrow', sig, escrow:r.escrow }); }
async function fund(){ const seller = document.getElementById('seller').value.trim();
  const r = await fetch('/api/onchain/fundTx',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyerPubkey:buyerPk,sellerPubkey:seller})}).then(r=>r.json());
  if(!r.ok) return out(r); const sig = await signSend(r.tx); out({ step:'fund', sig, escrow:r.escrow }); }
async function confirmDelivery(){ const seller = document.getElementById('seller').value.trim();
  const r = await fetch('/api/onchain/confirmTx',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyerPubkey:buyerPk,sellerPubkey:seller})}).then(r=>r.json());
  if(!r.ok) return out(r); const sig = await signSend(r.tx); out({ step:'confirmDelivery', sig, escrow:r.escrow }); }
async function refund(){ const seller = document.getElementById('seller').value.trim();
  const r = await fetch('/api/onchain/refundTx',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyerPubkey:buyerPk,sellerPubkey:seller})}).then(r=>r.json());
  if(!r.ok) return out(r); const sig = await signSend(r.tx); out({ step:'refund', sig, escrow:r.escrow }); }
document.getElementById('btnConnect').onclick=connect; document.getElementById('btnInit').onclick=initEscrow; document.getElementById('btnFund').onclick=fund; document.getElementById('btnConfirm').onclick=confirmDelivery; document.getElementById('btnRefund').onclick=refund;
</script>
</body></html>
